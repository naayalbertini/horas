<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Registro de Horas</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>

<style>
    /* Estilos base (Otimizados) */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f4f7f6; 
        margin: 0; 
        padding: 0; 
    }
    .container {
        width: 95%; 
        max-width: 1200px; 
        margin: 30px auto; 
        background: white;
        padding: 40px; 
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08); 
    }
    h2 {
        text-align: center;
        margin-top: 0; 
        margin-bottom: 30px;
        color: #1f3a93; 
        border-bottom: 3px solid #1f3a93;
        padding-bottom: 10px;
    }
    label { 
        font-weight: 600; 
        color: #333;
        display: block; 
        margin-top: 10px;
    } 
    input, select {
        width: 100%;
        padding: 12px;
        margin: 5px 0 15px;
        border: 1px solid #c8d0d4; 
        border-radius: 5px;
        box-sizing: border-box; 
        transition: border-color 0.3s;
    }
    input:focus {
        border-color: #4a90e2; 
        outline: none;
    }
    button {
        width: 100%;
        padding: 14px;
        background: #4a90e2; 
        border: none;
        color: white;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
        transition: background 0.3s, transform 0.1s;
    }
    button:hover { 
        background: #3a7bd5; 
        transform: translateY(-1px);
    }
    .btn-pdf { 
        background: #00b894; 
        margin-bottom: 20px;
    }
    .btn-pdf:hover { background: #00997e; }

    /* Estilos para a área de filtro */
    #filtros {
        display: flex;
        flex-wrap: wrap; 
        gap: 20px;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        background: #eef3f7; 
    }
    #filtros > div {
        flex: 1 1 200px; 
    }
    #filtros button {
        margin-top: 25px; 
        padding: 12px;
        font-size: 15px;
    }
    
    /* AGRUPAMENTO PRINCIPAL POR FUNCIONÁRIO */
    .agrupamento-funcionario {
        border-left: 5px solid #1f3a93; 
        border-radius: 6px;
        padding: 20px 20px 10px 20px;
        margin-bottom: 30px; 
        background: #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .agrupamento-funcionario h2 {
        text-align: left;
        color: #1f3a93; 
        border-bottom: none;
        margin-bottom: 10px;
        padding-bottom: 0;
        font-size: 1.8em;
    }

    /* Estilo para o cálculo em tempo real */
    #totalDuracaoDia {
        background: #f0f8ff;
        border: 1px solid #d0e4f7;
        padding: 10px;
        border-radius: 5px;
        margin: 15px 0;
        font-weight: bold;
        color: #1f3a93;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Estilos dos relatórios (mantidos) */
    .agrupamento-mes { margin-top: 15px; border: 1px solid #d4e0e4; border-radius: 8px; overflow: hidden; }
    .mes-header { color: #2c3e50; background: #eef3f7; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin: 0; font-size: 1.2em; font-weight: 600; transition: background 0.2s; }
    .mes-header:hover { background: #e0e8ed; }
    .mes-header i { transition: transform 0.3s; }
    .mes-header.open i { transform: rotate(90deg); }
    .mes-header .total-mes-header { font-size: 0.9em; font-weight: bold; background: #fff; color: #4a90e2; padding: 5px 10px; border-radius: 20px; border: 1px solid #4a90e2; }
    .registros-agrupados-mes { padding: 15px; background: #fdfdfd; }
    .agrupamento-semana { border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 15px; padding: 10px; background: #ffffff; }
    .semana-header { color: #555; font-size: 1.05em; margin-top: 0; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed #e0e0e0; display: flex; justify-content: space-between; font-weight: 600; }
    .total-semana { margin-top: 15px; padding: 8px; background: #f0f8ff; border-radius: 4px; text-align: center; font-weight: bold; font-size: 0.9em; color: #1f3a93; border: 1px solid #d0e4f7; }
    .registros-agrupados-semana { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
    .registro { background: #ffffff; padding: 15px; border-radius: 8px; border: 1px solid #f0f0f0; flex: 1 1 calc(33% - 15px); min-width: 250px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .registro p { margin: 5px 0; line-height: 1.4; }
    .registro strong { color: #1f3a93; font-weight: 700; }
    .acoes { display: flex; gap: 10px; margin-top: 15px; }
    .acoes button { flex: 1; padding: 8px; margin-top: 0; font-size: 12px; border-radius: 4px; }
    .acoes button.editar { background: #f39c12; }
    .acoes button.editar:hover { background: #e67e22; }
    .acoes button.excluir { background: #e74c3c; }
    .acoes button.excluir:hover { background: #c0392b; }
</style>
</head>
<body>
<div class="container">
    <h2><i class="fas fa-clock"></i> Registro de Horas</h2>

    <label>Funcionário:</label>
    <input type="text" id="funcionario" list="listaFuncionarios" required>
    <datalist id="listaFuncionarios"></datalist>

    <label>Data:</label>
    <input type="date" id="data">

    <div id="blocos"></div>
    
    <div id="totalDuracaoDia">
        <i class="fas fa-calculator"></i> Duração Calculada do Dia: <span id="duracaoAtual">00h 00m</span>
    </div>

    <button onclick="window.addBloco()"><i class="fas fa-plus"></i> Adicionar Entrada/Saída</button>
    <button id="btnSalvar" onclick="window.salvarDados()"><i class="fas fa-save"></i> Salvar Registro</button>
    <button class="btn-pdf" onclick="window.gerarPDF()"><i class="fas fa-file-pdf"></i> Gerar PDF de **Todos** os Registros</button>

    <h2><i class="fas fa-filter"></i> Filtros de Busca</h2>
    <div id="filtros">
        <div>
            <label for="filtroFuncionario">Filtrar por Funcionário:</label>
            <input type="text" id="filtroFuncionario" placeholder="Nome completo ou parte do nome" onkeyup="window.aplicarFiltro()">
        </div>
        <div>
            <label for="filtroDataInicial">Data Inicial:</label>
            <input type="date" id="filtroDataInicial" onchange="window.aplicarFiltro()">
        </div>
        <div>
            <label for="filtroDataFinal">Data Final:</label>
            <input type="date" id="filtroDataFinal" onchange="window.aplicarFiltro()">
        </div>
        <div>
            <button onclick="window.aplicarFiltro()">Buscar</button>
        </div>
    </div>
    
    <h2><i class="fas fa-folder-open"></i> Registros Agrupados por Mês e Semana</h2>
    <div id="lista"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ATENÇÃO: Use suas próprias credenciais do Firebase!
    const firebaseConfig = {
        apiKey: "AIzaSyDJWyk_B2rl6_dSKLL7s5cgQiyE7yr9ts0", 
        authDomain: "registrohoras-7a805.firebaseapp.com",
        projectId: "registrohoras-7a805",
        storageBucket: "registrohoras-7a805.firebasestorage.app",
        messagingSenderId: "398934901336",
        appId: "1:398934901336:web:b72de732481bfd955d802d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let blocos = 0;
    let todosOsRegistros = []; 
    let registrosGlobais = []; 
    let registrosAgrupados = {}; 
    let canonicalNamesMap = new Map(); 

    // #######################################################
    // FUNÇÕES AUXILIARES DE TEXTO, DATA E CÁLCULO
    // #######################################################

    const meses = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    
    function removerAcentos(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function getSortableDate(dataISO) {
        if (!dataISO) return '';
        const partes = dataISO.split('-');
        if (partes.length === 3) {
            let dia, mes, ano;
            if (partes[0].length === 4) { 
                [ano, mes, dia] = partes;
            } else {
                [dia, mes, ano] = partes;
            }
            return `${ano}-${mes}-${dia}`;
        }
        return dataISO;
    }

    function formatarDataBR(dataISO) {
        const sortableDate = getSortableDate(dataISO);
        if (!sortableDate) return '';
        
        const partes = sortableDate.split('-');
        const ano = partes[0];
        const mes = partes[1];
        const dia = partes[2];
        const mesNum = parseInt(mes, 10);
        
        if (mesNum >= 1 && mesNum <= 12) {
            const nomeMes = meses[mesNum - 1]; 
            return `${dia}/${nomeMes}/${ano}`; 
        }
        return `${dia}/${mes}/${ano}`; 
    }

    function formatarMesAnoBR(dataISO) {
        const sortableDate = getSortableDate(dataISO); 
        if (!sortableDate) return 'Desconhecido';
        
        const [ano, mes] = sortableDate.split('-');
        const mesNum = parseInt(mes, 10);

        if (mesNum >= 1 && mesNum <= 12) {
            return `${meses[mesNum - 1]}/${ano}`; 
        }
        return `Inválido/${ano}`;
    }

    function getWeekNumber(dateISO) {
        if (!dateISO) return { key: '9999-W99', display: 'Semana Desconhecida' };
        
        const date = new Date(dateISO + 'T00:00:00'); 
        const ano = date.getFullYear();
        
        const d = new Date(date.valueOf());
        const dayNum = d.getDay(); 
        d.setDate(d.getDate() + 4 - (dayNum === 0 ? 7 : dayNum)); 

        const yearStart = new Date(Date.UTC(d.getFullYear(), 0, 1));
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        
        const monday = new Date(date.valueOf());
        monday.setDate(date.getDate() - (dayNum === 0 ? 6 : dayNum - 1));

        const sunday = new Date(monday.valueOf());
        sunday.setDate(monday.getDate() + 6);

        const formattedStart = `${String(monday.getDate()).padStart(2, '0')}/${String(monday.getMonth() + 1).padStart(2, '0')}`;
        const formattedEnd = `${String(sunday.getDate()).padStart(2, '0')}/${String(sunday.getMonth() + 1).padStart(2, '0')}`;

        return {
            key: `${ano}-W${String(weekNo).padStart(2, '0')}`,
            display: `Semana ${weekNo} (${formattedStart} a ${formattedEnd})`
        };
    }

    function parseTime(timeStr) {
        if (!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return (h * 60) + m;
    }

    function formatarMinutosParaHora(minutosTotais) {
        if (minutosTotais < 0) return `-${formatarMinutosParaHora(Math.abs(minutosTotais))}`;
        const h = Math.floor(minutosTotais / 60);
        const m = minutosTotais % 60;
        const hFormatado = h.toString().padStart(2, '0');
        const mFormatado = m.toString().padStart(2, '0');
        return `${hFormatado}h ${mFormatado}m`;
    }

    function calcularDuracaoTotal(horarios) {
        let duracaoMinutos = 0;
        const horas = Array.isArray(horarios) ? horarios : []; 
        
        for (const h of horas) {
            if (h.entrada && h.saida) {
                const entradaMinutos = parseTime(h.entrada);
                const saidaMinutos = parseTime(h.saida);
                
                if (saidaMinutos > entradaMinutos) {
                    duracaoMinutos += (saidaMinutos - entradaMinutos);
                }
            }
        }
        return duracaoMinutos;
    }

    window.calcularDuracaoAtualDia = function() {
        const horarios = [];
        for (let i = 1; i <= blocos; i++) {
            const entrada = document.getElementById(`entrada${i}`)?.value;
            const saida = document.getElementById(`saida${i}`)?.value;
            if (entrada && saida) {
                 const entradaMinutos = parseTime(entrada);
                 const saidaMinutos = parseTime(saida);

                 if (saidaMinutos > entradaMinutos) {
                     horarios.push({ entrada, saida });
                 }
            }
        }
        const totalMinutos = calcularDuracaoTotal(horarios);
        document.getElementById('duracaoAtual').textContent = formatarMinutosParaHora(totalMinutos);
    }
    
    // #######################################################
    // FUNÇÕES DE NOME CANÔNICO
    // #######################################################
    
    function getCanonicalName(funcionarioInput) {
        const nomeInput = funcionarioInput.trim();
        const nomeNormalizado = removerAcentos(nomeInput).toLowerCase();
        
        if (canonicalNamesMap.has(nomeNormalizado)) {
            return canonicalNamesMap.get(nomeNormalizado);
        }
        
        canonicalNamesMap.set(nomeNormalizado, nomeInput); 
        return nomeInput;
    }

    // #######################################################
    // FUNÇÕES CRUD E UX (CORRIGIDAS)
    // #######################################################

    window.addBloco = function(entradaVal = '', saidaVal = '') {
        blocos++;
        const div = document.createElement('div');
        div.className = 'registro';
        div.id = `bloco${blocos}`;
        div.innerHTML = `
            <label>Entrada:</label>
            <input type="time" id="entrada${blocos}" value="${entradaVal}" onchange="window.calcularDuracaoAtualDia()">
            <label>Saída:</label>
            <input type="time" id="saida${blocos}" value="${saidaVal}" onchange="window.calcularDuracaoAtualDia()">
        `;
        document.getElementById('blocos').appendChild(div);
        window.calcularDuracaoAtualDia(); 
    }

    window.salvarDados = async function() {
        const funcionarioInput = document.getElementById('funcionario').value.trim(); 
        const data = document.getElementById('data').value; 

        if (!funcionarioInput || !data) {
            alert("Preencha funcionário e data!");
            return;
        }
        
        const funcionarioParaSalvar = getCanonicalName(funcionarioInput);

        const horarios = [];
        let totalMinutos = 0;
        let erroValidacao = false;

        for (let i = 1; i <= blocos; i++) {
            const entrada = document.getElementById(`entrada${i}`)?.value;
            const saida = document.getElementById(`saida${i}`)?.value;

            if (entrada && saida) {
                const entradaMinutos = parseTime(entrada);
                const saidaMinutos = parseTime(saida);
                
                if (saidaMinutos <= entradaMinutos) {
                    alert(`Erro no bloco ${i}: A hora de Saída (${saida}) deve ser maior que a hora de Entrada (${entrada}).`);
                    erroValidacao = true;
                    break;
                }

                horarios.push({ entrada, saida });
                totalMinutos += (saidaMinutos - entradaMinutos);
            }
        }
        
        if (erroValidacao) return;

        if (horarios.length === 0 || totalMinutos === 0) {
            alert("Adicione pelo menos um par de Entrada/Saída válido.");
            return;
        }

        try {
            await addDoc(collection(db, "horas"), {
                funcionario: funcionarioParaSalvar, 
                data,
                horarios
            });
            
            document.getElementById('data').value = ''; 
            document.getElementById('blocos').innerHTML = '';
            blocos = 0;
            window.addBloco(); 
            
            carregarTodosOsDados(); 
            alert(`Registro de horas para ${formatarDataBR(data)} salvo com sucesso!`);
        } catch (e) {
            console.error("Erro ao adicionar documento: ", e);
            alert("Erro ao salvar. Verifique a console.");
        }
    }

    window.atualizarDados = async function(id) {
        const funcionarioInput = document.getElementById('funcionario').value.trim();
        const data = document.getElementById('data').value; 
        
        if (!funcionarioInput || !data) {
            alert("Preencha funcionário e data!");
            return;
        }
        
        const funcionarioParaSalvar = getCanonicalName(funcionarioInput); 

        const horarios = [];
        let totalMinutos = 0;
        let erroValidacao = false;
        
        for (let i = 1; i <= blocos; i++) { 
            const entrada = document.getElementById(`entrada${i}`)?.value;
            const saida = document.getElementById(`saida${i}`)?.value;

            if (entrada && saida) {
                const entradaMinutos = parseTime(entrada);
                const saidaMinutos = parseTime(saida);

                if (saidaMinutos <= entradaMinutos) {
                    alert(`Erro no bloco ${i}: A hora de Saída (${saida}) deve ser maior que a hora de Entrada (${entrada}).`);
                    erroValidacao = true;
                    break;
                }

                horarios.push({ entrada, saida });
                totalMinutos += (saidaMinutos - entradaMinutos);
            }
        }
        
        if (erroValidacao) return;

        if (horarios.length === 0 || totalMinutos === 0) {
            alert("Preencha funcionário, data e pelo menos um par de horários válido!");
            return;
        }
        
        try {
            const docRef = doc(db, "horas", id);
            await updateDoc(docRef, { 
                funcionario: funcionarioParaSalvar, 
                data, 
                horarios 
            });

            // CORREÇÃO: Seleciona o botão pelo ID e reverte para o estado de salvar
            const salvarBtn = document.getElementById('btnSalvar');
            
            if (salvarBtn) {
                salvarBtn.textContent = 'Salvar Registro';
                salvarBtn.onclick = () => window.salvarDados(); // Reverte a função de clique
            }

            document.getElementById('funcionario').value = '';
            document.getElementById('data').value = '';
            document.getElementById('blocos').innerHTML = '';
            blocos = 0; 
            window.addBloco(); 
            
            window.carregarTodosOsDados(); 
            alert("Registro atualizado com sucesso!");

        } catch (e) {
            console.error("Erro ao atualizar: ", e);
            alert("Erro ao atualizar. Verifique a console (tecla F12).");
        }
    }

    window.editar = async function(id) {
        try {
            const docRef = doc(db, "horas", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();

                document.getElementById('funcionario').value = data.funcionario;
                document.getElementById('data').value = getSortableDate(data.data);

                document.getElementById('blocos').innerHTML = '';
                blocos = 0;
                const horarios = Array.isArray(data.horarios) ? data.horarios : []; 

                horarios.forEach(h => {
                    window.addBloco(h.entrada, h.saida); 
                });
                
                window.calcularDuracaoAtualDia(); 

                // CORREÇÃO: Seleciona o botão pelo ID e prepara para a atualização
                const salvarBtn = document.getElementById('btnSalvar');
                if (salvarBtn) {
                    salvarBtn.textContent = 'Atualizar Registro';
                    salvarBtn.onclick = () => window.atualizarDados(id); // Define a função de clique para atualizar
                }

                alert("Dados carregados para edição. Clique em 'Atualizar Registro' para salvar as mudanças.");

            } else {
                alert("Registro não encontrado!");
            }
        } catch (e) {
            console.error("Erro ao editar: ", e);
            alert("Erro ao carregar dados para edição. Verifique a console.");
        }
    }
    
    // ... (As outras funções de carregamento, filtro, exclusão e PDF permanecem inalteradas, mas incluídas abaixo por integridade) ...

    window.carregarTodosOsDados = async function() {
        const querySnapshot = await getDocs(collection(db, "horas"));
        todosOsRegistros = []; 

        canonicalNamesMap = new Map();

        querySnapshot.forEach(docItem => {
            const d = docItem.data();
            const horariosArray = Array.isArray(d.horarios) ? d.horarios : []; 
            const duracaoDoDiaMinutos = calcularDuracaoTotal(horariosArray);

            todosOsRegistros.push({
                ...d, 
                horarios: horariosArray, 
                id: docItem.id, 
                duracaoMinutos: duracaoDoDiaMinutos,
                duracaoFormatada: formatarMinutosParaHora(duracaoDoDiaMinutos)
            });
            
            const nomeOriginal = d.funcionario.trim();
            const nomeNormalizado = removerAcentos(nomeOriginal).toLowerCase(); 

            if (!canonicalNamesMap.has(nomeNormalizado)) {
                canonicalNamesMap.set(nomeNormalizado, nomeOriginal);
            }
        });

        const nomesCanonicossParaDatalist = Array.from(canonicalNamesMap.values()).sort();

        const datalist = document.getElementById('listaFuncionarios');
        datalist.innerHTML = '';
        nomesCanonicossParaDatalist.forEach(nome => {
            const option = document.createElement('option');
            option.value = nome;
            datalist.appendChild(option);
        });

        window.aplicarFiltro();
    }

    window.toggleVisibility = function(elementId, headerElement) {
        const content = document.getElementById(elementId);
        if (content) {
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block'; 
                headerElement.classList.add('open');
            } else {
                content.style.display = 'none';
                headerElement.classList.remove('open');
            }
        }
    }
    
    window.aplicarFiltro = function() {
        const lista = document.getElementById("lista");
        lista.innerHTML = "<h4>Aplicando filtros...</h4>";
        
        const filtroFuncionario = document.getElementById('filtroFuncionario').value.trim().toLowerCase();
        const filtroDataInicial = document.getElementById('filtroDataInicial').value;
        const filtroDataFinal = document.getElementById('filtroDataFinal').value;
        
        registrosGlobais = []; 
        registrosAgrupados = {}; 
        
        const registrosFiltrados = todosOsRegistros.filter(registro => {
            const nomeCorresponde = removerAcentos(registro.funcionario).toLowerCase().includes(removerAcentos(filtroFuncionario));
            
            const dataCorresponde = 
                (!filtroDataInicial || registro.data >= filtroDataInicial) &&
                (!filtroDataFinal || registro.data <= filtroDataFinal);
            return nomeCorresponde && dataCorresponde;
        });

        registrosFiltrados.forEach(registro => {
            const nomeFuncionario = registro.funcionario;
            const duracaoDoDiaMinutos = registro.duracaoMinutos;
            const mesAno = formatarMesAnoBR(registro.data); 
            const semana = getWeekNumber(registro.data);

            registrosGlobais.push(registro); 
            
            if (!registrosAgrupados[nomeFuncionario]) {
                registrosAgrupados[nomeFuncionario] = { gruposPorMes: {} };
            }
            
            if (!registrosAgrupados[nomeFuncionario].gruposPorMes[mesAno]) {
                registrosAgrupados[nomeFuncionario].gruposPorMes[mesAno] = {
                    totalMinutosMes: 0,
                    gruposPorSemana: {}
                };
            }
            
            if (!registrosAgrupados[nomeFuncionario].gruposPorMes[mesAno].gruposPorSemana[semana.key]) {
                registrosAgrupados[nomeFuncionario].gruposPorMes[mesAno].gruposPorSemana[semana.key] = {
                    registros: [],
                    totalMinutosSemana: 0,
                    display: semana.display
                };
            }
            
            registrosAgrupados[nomeFuncionario].gruposPorMes[mesAno].gruposPorSemana[semana.key].registros.push(registro);
            registrosAgrupados[nomeFuncionario].gruposPorMes[mesAno].gruposPorSemana[semana.key].totalMinutosSemana += duracaoDoDiaMinutos;
            registrosAgrupados[nomeFuncionario].gruposPorMes[mesAno].totalMinutosMes += duracaoDoDiaMinutos;
        });
        
        let htmlContent = ''; 

        for (const funcionario in registrosAgrupados) {
            const grupoFuncionario = registrosAgrupados[funcionario];
            let mesesHTML = '';
            
            const mesesOrdenados = Object.keys(grupoFuncionario.gruposPorMes).sort((a, b) => {
                const aParts = a.split('/');
                const bParts = b.split('/');
                const monthAIndex = meses.findIndex(m => m === aParts[0]) + 1;
                const monthBIndex = meses.findIndex(m => m === bParts[0]) + 1;
                const sortKeyA = `${aParts[1]}-${String(monthAIndex).padStart(2, '0')}`;
                const sortKeyB = `${bParts[1]}-${String(monthBIndex).padStart(2, '0')}`;
                return sortKeyA.localeCompare(sortKeyB);
            });


            for (const mesAno of mesesOrdenados) {
                const grupoMes = grupoFuncionario.gruposPorMes[mesAno];
                const contentId = `content-mes-${funcionario.replace(/\s/g, '_')}-${mesAno.replace('/', '-')}`;
                
                let semanasHTML = '';
                const semanasOrdenadas = Object.keys(grupoMes.gruposPorSemana).sort(); 

                for (const semanaKey of semanasOrdenadas) {
                    const grupoSemana = grupoMes.gruposPorSemana[semanaKey];
                    
                    const registrosHTML = grupoSemana.registros
                        .sort((a, b) => getSortableDate(a.data).localeCompare(getSortableDate(b.data)))
                        .map(registro => {
                            const horariosDisplay = registro.horarios.map(h => `${h.entrada} &rarr; ${h.saida}`).join('<br>');
                            const dataFormatada = formatarDataBR(registro.data); 

                            return `
                            <div class="registro">
                                <p><strong><i class="fas fa-calendar-day"></i> Data:</strong> ${dataFormatada}</p>
                                <p><strong><i class="fas fa-business-time"></i> Horários:</strong></p>
                                ${horariosDisplay}
                                <hr style="margin: 5px 0; border-top: 1px dashed #eee;">
                                <p><strong><i class="fas fa-hourglass-half"></i> Total do Dia:</strong> ${registro.duracaoFormatada}</p>
                                <div class="acoes">
                                    <button class="editar" onclick="window.editar('${registro.id}')"><i class="fas fa-edit"></i> Editar</button>
                                    <button class="excluir" onclick="window.excluir('${registro.id}')"><i class="fas fa-trash-alt"></i> Excluir</button>
                                </div>
                            </div>
                        `}).join('');
                    
                    semanasHTML += `
                        <div class="agrupamento-semana">
                            <h4 class="semana-header">
                                <i class="fas fa-calendar-week"></i> ${grupoSemana.display}
                            </h4>
                            <div class="registros-agrupados-semana">
                                ${registrosHTML}
                            </div>
                            <div class="total-semana">
                                Total da Semana: ${formatarMinutosParaHora(grupoSemana.totalMinutosSemana)}
                            </div>
                        </div>
                    `;
                }


                mesesHTML += `
                    <div class="agrupamento-mes">
                        <h3 class="mes-header" onclick="window.toggleVisibility('${contentId}', this)">
                            <i class="fas fa-folder"></i> Mês de ${mesAno}
                            <span class="total-mes-header">
                                ${formatarMinutosParaHora(grupoMes.totalMinutosMes)}
                                <i class="fas fa-chevron-right"></i>
                            </span>
                        </h3>
                        
                        <div id="${contentId}" class="registros-agrupados-mes" style="display: none;">
                            ${semanasHTML}
                        </div>
                    </div>
                `;
            }
            
            const funcionarioSafeName = funcionario.replace(/'/g, "\\'"); 
            
            htmlContent += `
                <div class="agrupamento-funcionario">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2>${funcionario}</h2>
                        <button class="btn-pdf" style="width: auto; padding: 8px 15px; margin: 0; font-size: 14px; background: #2980b9;" 
                                onclick="window.gerarPDFSemanalPorFuncionario('${funcionarioSafeName}')">
                            <i class="fas fa-file-pdf"></i> PDF Semanal
                        </button>
                    </div>
                    ${mesesHTML} 
                </div>
            `;
        }
        
        lista.innerHTML = htmlContent || "<h4>Nenhum registro encontrado com os filtros aplicados.</h4>"; 
    }
    
    window.excluir = async function(id) {
        if (!confirm("Tem certeza que deseja excluir este registro?")) return;
        try {
            await deleteDoc(doc(db, "horas", id));
            carregarTodosOsDados(); 
            alert("Registro excluído com sucesso!");
        } catch (e) {
            console.error("Erro ao excluir: ", e);
            alert("Erro ao excluir. Verifique a console.");
        }
    }

    window.gerarPDFSemanalPorFuncionario = function(funcionarioNome) {
        if (!window.jspdf || !window.jspdf.jsPDF) {
            alert("Erro: Biblioteca jsPDF não carregada. Verifique sua conexão ou os links.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 10;
        
        doc.setFontSize(16);
        doc.text(`Relatório Semanal de Horas: ${funcionarioNome}`, 10, y);
        y += 10;

        const grupoFuncionario = registrosAgrupados[funcionarioNome];
        if (!grupoFuncionario) {
            alert(`Dados para o funcionário ${funcionarioNome} não encontrados no relatório atual. Tente buscar ou aplicar filtros primeiro.`);
            return;
        }
        
        let totalFinal = 0;

        const mesesOrdenados = Object.keys(grupoFuncionario.gruposPorMes).sort((a, b) => {
            const aParts = a.split('/');
            const bParts = b.split('/');
            const monthAIndex = meses.findIndex(m => m === aParts[0]) + 1;
            const monthBIndex = meses.findIndex(m => m === bParts[0]) + 1;
            const sortKeyA = `${aParts[1]}-${String(monthAIndex).padStart(2, '0')}`;
            const sortKeyB = `${bParts[1]}-${String(monthBIndex).padStart(2, '0')}`;
            return sortKeyA.localeCompare(sortKeyB);
        });

        for (const mesAno of mesesOrdenados) {
            const grupoMes = grupoFuncionario.gruposPorMes[mesAno];
            
            if (y + 15 > 270) { doc.addPage(); y = 10; }
            
            doc.setFontSize(12);
            doc.setTextColor(0, 86, 179);
            doc.text(`Mês: ${mesAno} (Total: ${formatarMinutosParaHora(grupoMes.totalMinutosMes)})`, 10, y + 2);
            doc.setTextColor(0, 0, 0);
            y += 6;
            totalFinal += grupoMes.totalMinutosMes;

            const semanasOrdenadas = Object.keys(grupoMes.gruposPorSemana).sort();

            for (const semanaKey of semanasOrdenadas) {
                const grupoSemana = grupoMes.gruposPorSemana[semanaKey];
                
                if (y + 30 > 270) { doc.addPage(); y = 10; }

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`> ${grupoSemana.display} (Total Semanal: ${formatarMinutosParaHora(grupoSemana.totalMinutosSemana)})`, 15, y + 2);
                doc.setTextColor(0, 0, 0);
                y += 6;

                const head = [["Data", "Entrada", "Saída", "Total do Dia"]];
                const body = grupoSemana.registros
                    .sort((a, b) => getSortableDate(a.data).localeCompare(getSortableDate(b.data)))
                    .map(reg => [
                        formatarDataBR(reg.data), 
                        Array.isArray(reg.horarios) ? reg.horarios.map(h => h.entrada).join('\n') : '',
                        Array.isArray(reg.horarios) ? reg.horarios.map(h => h.saida).join('\n') : '',
                        reg.duracaoFormatada
                    ]);
                
                doc.autoTable({
                    startY: y,
                    head: head,
                    body: body,
                    theme: 'grid',
                    margin: { left: 15, right: 10 },
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [74, 144, 226] }
                });

                y = doc.autoTable.previous.finalY + 2;
            }
            
            y += 4; 
        }

        if (y > 270) { doc.addPage(); y = 10; }
        doc.setFontSize(12);
        doc.setTextColor(21, 87, 36);
        doc.text(`TOTAL ACUMULADO de ${funcionarioNome} (Período Filtrado): ${formatarMinutosParaHora(totalFinal)}`, 10, y + 4);
        doc.setTextColor(0, 0, 0);
        y += 12;

        const nomeArquivo = `relatorio_semanal_${funcionarioNome.replace(/[^a-zA-Z0-9]/g, '_')}_filtrado.pdf`;
        doc.save(nomeArquivo);
    }
    
    window.gerarPDF = function() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
            alert("Erro: Biblioteca jsPDF não carregada. Verifique sua conexão ou os links.");
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text("Relatório Geral de Horas por Funcionário, Mês e Semana", 10, 10);
        
        let y = 20;
        let totalGeralMinutosPDF = 0;

        const registrosParaPDF = {};
        registrosGlobais.forEach(reg => { 
            const funcionario = reg.funcionario;
            const mesAno = formatarMesAnoBR(reg.data);
            const semana = getWeekNumber(reg.data);

            if (!registrosParaPDF[funcionario]) {
                registrosParaPDF[funcionario] = { gruposPorMes: {}, totalMinutosFuncionario: 0 };
            }

            if (!registrosParaPDF[funcionario].gruposPorMes[mesAno]) {
                registrosParaPDF[funcionario].gruposPorMes[mesAno] = { gruposPorSemana: {}, totalMinutosMes: 0 };
            }

            if (!registrosParaPDF[funcionario].gruposPorMes[mesAno].gruposPorSemana[semana.key]) {
                 registrosParaPDF[funcionario].gruposPorMes[mesAno].gruposPorSemana[semana.key] = { registros: [], totalMinutosSemana: 0, display: semana.display };
            }
            
            registrosParaPDF[funcionario].gruposPorMes[mesAno].gruposPorSemana[semana.key].registros.push(reg);
        });

        for (const funcionario in registrosParaPDF) {
            const func = registrosParaPDF[funcionario];
            func.totalMinutosFuncionario = 0;

            for (const mesAno in func.gruposPorMes) {
                const mes = func.gruposPorMes[mesAno];
                mes.totalMinutosMes = 0;
                
                for (const semanaKey in mes.gruposPorSemana) {
                    const semana = mes.gruposPorSemana[semanaKey];
                    semana.totalMinutosSemana = semana.registros.reduce((sum, reg) => sum + reg.duracaoMinutos, 0); 
                    mes.totalMinutosMes += semana.totalMinutosSemana;
                }
                func.totalMinutosFuncionario += mes.totalMinutosMes;
            }
        }
        
        for (const funcionario in registrosParaPDF) {
            const grupoFuncionario = registrosParaPDF[funcionario];
            
            if (y > 270) { doc.addPage(); y = 10; }

            doc.setFontSize(14);
            doc.text(`Funcionário: ${funcionario}`, 10, y);
            y += 8;
            
            const mesesOrdenados = Object.keys(grupoFuncionario.gruposPorMes).sort((a, b) => {
                const aParts = a.split('/');
                const bParts = b.split('/');
                const monthAIndex = meses.findIndex(m => m === aParts[0]) + 1;
                const monthBIndex = meses.findIndex(m => m === bParts[0]) + 1;
                const sortKeyA = `${aParts[1]}-${String(monthAIndex).padStart(2, '0')}`;
                const sortKeyB = `${bParts[1]}-${String(monthBIndex).padStart(2, '0')}`;
                return sortKeyA.localeCompare(sortKeyB);
            });

            for (const mesAno of mesesOrdenados) {
                const grupoMes = grupoFuncionario.gruposPorMes[mesAno];
                
                doc.setFontSize(12);
                doc.setTextColor(0, 86, 179);
                doc.text(`Mês: ${mesAno} (Total: ${formatarMinutosParaHora(grupoMes.totalMinutosMes)})`, 10, y + 2);
                doc.setTextColor(0, 0, 0);
                y += 6;

                const semanasOrdenadas = Object.keys(grupoMes.gruposPorSemana).sort();

                for (const semanaKey of semanasOrdenadas) {
                    const grupoSemana = grupoMes.gruposPorSemana[semanaKey];
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`> ${grupoSemana.display} (Total: ${formatarMinutosParaHora(grupoSemana.totalMinutosSemana)})`, 15, y + 2);
                    doc.setTextColor(0, 0, 0);
                    y += 6;

                    const head = [["Data", "Entrada", "Saída", "Total do Dia"]];
                    const body = grupoSemana.registros
                        .sort((a, b) => getSortableDate(a.data).localeCompare(getSortableDate(b.data)))
                        .map(reg => [
                            formatarDataBR(reg.data), 
                            Array.isArray(reg.horarios) ? reg.horarios.map(h => h.entrada).join('\n') : '',
                            Array.isArray(reg.horarios) ? reg.horarios.map(h => h.saida).join('\n') : '',
                            reg.duracaoFormatada
                        ]);
                    
                    doc.autoTable({
                        startY: y,
                        head: head,
                        body: body,
                        theme: 'grid',
                        margin: { left: 15, right: 10 },
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [0, 123, 255] }
                    });

                    y = doc.autoTable.previous.finalY + 2;
                }
                
                y += 4;
            }
            
            doc.setFontSize(12);
            doc.setTextColor(21, 87, 36);
            doc.text(`TOTAL ACUMULADO de ${funcionario} (Período Filtrado): ${formatarMinutosParaHora(grupoFuncionario.totalMinutosFuncionario)}`, 10, y + 4);
            doc.setTextColor(0, 0, 0);
            y += 12;

            totalGeralMinutosPDF += grupoFuncionario.totalMinutosFuncionario;
        }

        if (y > 270) { doc.addPage(); y = 10; }
        doc.setFontSize(14);
        doc.text(`Total GERAL dos Registros Exibidos no Relatório: ${formatarMinutosParaHora(totalGeralMinutosPDF)}`, 10, y + 10);

        doc.save("relatorio_horas_semanal_agrupado.pdf");
    }


    // Inicialização
    window.carregarTodosOsDados();
    window.addBloco(); 
</script>
</body>
</html>
