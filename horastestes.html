<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Registro de Horas</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>

<style>
    /* Estilos gerais */
    body {
        font-family: Arial, sans-serif;
        background: #e9ecf1; 
        margin: 0; 
        padding: 0; 
    }
    .container {
        width: 95%; 
        max-width: 1400px; 
        margin: 30px auto; 
        background: white;
        padding: 40px; 
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    }
    h2 {
        text-align: center;
        margin-top: 0; 
        margin-bottom: 25px;
        color: #333;
    }
    label { font-weight: 600; } 
    input, select {
        width: 100%;
        padding: 12px;
        margin: 5px 0 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box; 
    }
    button {
        width: 100%;
        padding: 14px;
        background: #007bff;
        border: none;
        color: white;
        border-radius: 6px;
        font-size: 17px;
        cursor: pointer;
        margin-top: 10px;
        transition: background 0.3s;
    }
    button:hover { background: #0056b3; }
    .btn-pdf { background: #28a745; }
    .btn-pdf:hover { background: #1e7e34; }

    /* Estilos para a ﾃ｡rea de filtro */
    #filtros {
        display: flex;
        flex-wrap: wrap; 
        gap: 20px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 30px;
        background: #f7f7f7;
    }
    #filtros > div {
        flex: 1 1 200px; 
    }
    #filtros button {
        margin-top: 30px; 
        padding: 12px;
        font-size: 16px;
    }
    
    /* Estilo para o agrupamento e colunas */
    #lista {
        min-height: 50px; 
        padding: 10px 0; 
    }
    .agrupamento-funcionario {
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 40px; 
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .agrupamento-funcionario h2 {
        text-align: left;
        color: #007bff; 
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .registros-agrupados {
        display: flex;
        flex-wrap: wrap; 
        gap: 30px; 
        margin-top: 15px;
    }
    .registro {
        background: #fdfdfd;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
        flex: 1 1 calc(30% - 30px); 
        min-width: 280px; 
        box-shadow: 0 1px 4px rgba(0,0,0,0.08); 
        margin-bottom: 15px; 
    }
    .registro p {
        margin: 5px 0;
        line-height: 1.4;
    }
    .registro strong {
        color: #555;
    }
    .total-funcionario {
        margin-top: 25px;
        padding: 15px;
        background: #e6f3ff; 
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
        font-size: 1.1em;
        color: #0056b3;
        border: 1px solid #b3d9ff;
    }
    .acoes {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .acoes button {
        flex: 1;
        padding: 10px; 
        margin-top: 0;
        font-size: 14px;
    }
    .acoes button.editar {
        background: #17a2b8; 
    }
    .acoes button.excluir {
        background: #dc3545;
    }
</style>
</head>
<body>
<div class="container">
    <h2>Registro de Horas</h2>

    <label>Funcionﾃ｡rio:</label>
    <input type="text" id="funcionario">

    <label>Data:</label>
    <input type="date" id="data">

    <div id="blocos"></div>

    <button onclick="window.addBloco()">Adicionar Entrada/Saﾃｭda</button>
    <button onclick="window.salvarDados()">Salvar Registro</button>
    <button class="btn-pdf" onclick="window.gerarPDF()">Gerar PDF de Todos os Registros</button>

    <h2>Filtros</h2>
    <div id="filtros">
        <div>
            <label for="filtroFuncionario">Filtrar por Funcionﾃ｡rio:</label>
            <input type="text" id="filtroFuncionario" placeholder="Nome completo ou parte do nome" onkeyup="window.aplicarFiltro()">
        </div>
        <div>
            <label for="filtroDataInicial">Data Inicial:</label>
            <input type="date" id="filtroDataInicial" onchange="window.aplicarFiltro()">
        </div>
        <div>
            <label for="filtroDataFinal">Data Final:</label>
            <input type="date" id="filtroDataFinal" onchange="window.aplicarFiltro()">
        </div>
        <div>
            <button onclick="window.aplicarFiltro()">Aplicar Filtros</button>
        </div>
    </div>
    
    <h2>Registros Salvos (Agrupados)</h2>
    <div id="lista"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ATENﾃﾃグ: Use suas prﾃｳprias credenciais do Firebase!
    const firebaseConfig = {
        apiKey: "AIzaSyDJWyk_B2rl6_dSKLL7s5cgQiyE7yr9ts0", 
        authDomain: "registrohoras-7a805.firebaseapp.com",
        projectId: "registrohoras-7a805",
        storageBucket: "registrohoras-7a805.firebasestorage.app",
        messagingSenderId: "398934901336",
        appId: "1:398934901336:web:b72de732481bfd955d802d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let blocos = 0;
    let todosOsRegistros = []; 
    let registrosGlobais = []; 
    let registrosAgrupados = {}; 

    // #######################################################
    // FUNﾃﾃ髭S AUXILIARES
    // #######################################################

    // 検 CORREﾃﾃグ DE DATA FINAL: Tenta deduzir o formato no Firebase e exibe com Mﾃｪs por extenso
    function formatarDataBR(dataISO) {
        if (!dataISO) return '';
        
        const meses = [
            'janeiro', 'fevereiro', 'marﾃｧo', 'abril', 'maio', 'junho',
            'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
        ];
        
        const partes = dataISO.split('-'); 
        
        if (partes.length === 3) {
            let dia, mes, ano;
            
            // Lﾃｳgica de Detecﾃｧﾃ｣o do Formato no Firebase
            if (partes[0].length === 4) { // Assume YYYY-MM-DD (Padrﾃ｣o ISO)
                ano = partes[0];
                mes = partes[1];
                dia = partes[2];
            } else if (parseInt(partes[1], 10) > 12) { // Tenta detectar se for DD-MM-YYYY (Ex: 01-11-2025)
                dia = partes[0];
                mes = partes[1];
                ano = partes[2];
            } else { // Caso padrﾃ｣o MM-DD-YYYY ou DD-MM-YYYY, assume DD-MM-YYYY (ﾃｺltima tentativa lﾃｳgica)
                dia = partes[0];
                mes = partes[1];
                ano = partes[2];
            }
            
            const mesNum = parseInt(mes, 10);
            
            // Verifica se o mﾃｪs estﾃ｡ dentro do intervalo vﾃ｡lido (1 a 12)
            if (mesNum >= 1 && mesNum <= 12) {
                const nomeMes = meses[mesNum - 1]; 
                
                // Formato DD/nome-do-mﾃｪs/YYYY
                return `${dia}/${nomeMes}/${ano}`; 
            } else {
                // Se o nﾃｺmero do mﾃｪs for invﾃ｡lido, retorna uma indicaﾃｧﾃ｣o clara
                return `${dia}/[Mﾃｪs Invﾃ｡lido:${mes}]/${ano}`; 
            }
        }
        
        return dataISO;
    }
    
    // Funﾃｧﾃ｣o auxiliar para obter a chave de ordenaﾃｧﾃ｣o no formato YYYY-MM-DD
    function getSortableDate(dataISO) {
        if (!dataISO) return '';
        const partes = dataISO.split('-');
        if (partes.length === 3) {
            let dia, mes, ano;
            
            // Lﾃｳgica de Detecﾃｧﾃ｣o do Formato (deve ser a mesma de formatarDataBR)
            if (partes[0].length === 4) { // YYYY-MM-DD
                [ano, mes, dia] = partes;
            } else { // DD-MM-YYYY ou MM-DD-YYYY (assume DD-MM-YYYY para ordenaﾃｧﾃ｣o)
                [dia, mes, ano] = partes;
            }
            // Retorna no formato YYYY-MM-DD para garantir a ordenaﾃｧﾃ｣o correta
            return `${ano}-${mes}-${dia}`;
        }
        return dataISO;
    }


    function parseTime(timeStr) {
        if (!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return (h * 60) + m;
    }

    function formatarMinutosParaHora(minutosTotais) {
        if (minutosTotais < 0) return `-${formatarMinutosParaHora(Math.abs(minutosTotais))}`;
        const h = Math.floor(minutosTotais / 60);
        const m = minutosTotais % 60;
        return `${h}h ${m}m`;
    }

    function calcularDuracaoTotal(horarios) {
        let duracaoMinutos = 0;
        const horas = Array.isArray(horarios) ? horarios : []; 
        
        for (const h of horas) {
            if (h.entrada && h.saida) {
                const entradaMinutos = parseTime(h.entrada);
                const saidaMinutos = parseTime(h.saida);
                
                if (saidaMinutos > entradaMinutos) {
                    duracaoMinutos += (saidaMinutos - entradaMinutos);
                }
            }
        }
        return duracaoMinutos;
    }

    // #######################################################
    // FUNﾃﾃグ PRINCIPAL DE CARREGAMENTO E FILTRAGEM
    // #######################################################

    window.carregarTodosOsDados = async function() {
        const querySnapshot = await getDocs(collection(db, "horas"));
        todosOsRegistros = []; 

        querySnapshot.forEach(docItem => {
            const d = docItem.data();
            const horariosArray = Array.isArray(d.horarios) ? d.horarios : []; 
            const duracaoDoDiaMinutos = calcularDuracaoTotal(horariosArray);

            todosOsRegistros.push({
                ...d, 
                horarios: horariosArray, 
                id: docItem.id, 
                duracaoMinutos: duracaoDoDiaMinutos,
                duracaoFormatada: formatarMinutosParaHora(duracaoDoDiaMinutos)
            });
        });
        window.aplicarFiltro();
    }

    window.aplicarFiltro = function() {
        const lista = document.getElementById("lista");
        lista.innerHTML = "<h4>Aplicando filtros...</h4>";
        
        const filtroFuncionario = document.getElementById('filtroFuncionario').value.trim().toLowerCase();
        const filtroDataInicial = document.getElementById('filtroDataInicial').value;
        const filtroDataFinal = document.getElementById('filtroDataFinal').value;
        
        registrosGlobais = []; 
        registrosAgrupados = {};
        let totalGeralMinutos = 0; 
        
        // 1. FILTRAGEM DOS DADOS MESTRES
        const registrosFiltrados = todosOsRegistros.filter(registro => {
            const nomeCorresponde = registro.funcionario.toLowerCase().includes(filtroFuncionario);
            
            // A data do Firebase ainda ﾃｩ comparada no seu formato original
            const dataCorresponde = 
                (!filtroDataInicial || registro.data >= filtroDataInicial) &&
                (!filtroDataFinal || registro.data <= filtroDataFinal);
                
            return nomeCorresponde && dataCorresponde;
        });

        // 2. AGRUPAMENTO E Cﾃ´CULO
        registrosFiltrados.forEach(registro => {
            const nomeFuncionario = registro.funcionario;
            const duracaoDoDiaMinutos = registro.duracaoMinutos;

            totalGeralMinutos += duracaoDoDiaMinutos; 
            
            registrosGlobais.push(registro); 
            
            if (!registrosAgrupados[nomeFuncionario]) {
                registrosAgrupados[nomeFuncionario] = {
                    registros: [],
                    totalMinutos: 0
                };
            }
            
            registrosAgrupados[nomeFuncionario].registros.push(registro);
            registrosAgrupados[nomeFuncionario].totalMinutos += duracaoDoDiaMinutos;
        });
        
        // 3. RENDERIZAﾃﾃグ
        let htmlContent = ''; 

        for (const funcionario in registrosAgrupados) {
            const grupo = registrosAgrupados[funcionario];
            
            const registrosHTML = grupo.registros
                // 検 CORREﾃﾃグ DE ORDENAﾃﾃグ: Usa a funﾃｧﾃ｣o auxiliar getSortableDate
                .sort((a, b) => {
                    const dataA = getSortableDate(a.data);
                    const dataB = getSortableDate(b.data);
                    return dataA.localeCompare(dataB);
                })
                .map(registro => {
                    const horariosDisplay = registro.horarios.map(h => `${h.entrada} &rarr; ${h.saida}`).join('<br>');
                    // Usa a funﾃｧﾃ｣o corrigida com mﾃｪs por extenso
                    const dataFormatada = formatarDataBR(registro.data); 

                    return `
                    <div class="registro">
                        <p><strong>Data:</strong> ${dataFormatada}</p>
                        <p><strong>Horﾃ｡rios:</strong></p>
                        ${horariosDisplay}
                        <hr style="margin: 5px 0;">
                        <p><strong>Total do Dia:</strong> ${registro.duracaoFormatada}</p>
                        <div class="acoes">
                            <button class="editar" onclick="window.editar('${registro.id}')">Editar</button>
                            <button class="excluir" onclick="window.excluir('${registro.id}')">Excluir</button>
                        </div>
                    </div>
                `}).join('');

            htmlContent += `
                <div class="agrupamento-funcionario">
                    <h2>${funcionario}</h2>
                    <div class="registros-agrupados">
                        ${registrosHTML}
                    </div>
                    <div class="total-funcionario">
                        Total Acumulado de ${funcionario}: ${formatarMinutosParaHora(grupo.totalMinutos)}
                    </div>
                </div>
            `;
        }
        
        lista.innerHTML = htmlContent || "<h4>Nenhum registro encontrado com os filtros aplicados.</h4>"; 
    }
    
    // #######################################################
    // FUNﾃﾃ髭S DE SALVAR/EDITAR/EXCLUIR
    // #######################################################

    window.addBloco = function() {
        blocos++;
        const div = document.createElement('div');
        div.className = 'registro';
        div.id = `bloco${blocos}`;
        div.innerHTML = `
            <label>Entrada:</label>
            <input type="time" id="entrada${blocos}">
            <label>Saﾃｭda:</label>
            <input type="time" id="saida${blocos}">
        `;
        document.getElementById('blocos').appendChild(div);
    }

    window.salvarDados = async function() {
        const funcionario = document.getElementById('funcionario').value.trim(); 
        // Salva a data no formato ISO YYYY-MM-DD (que o input type="date" envia)
        const data = document.getElementById('data').value; 

        if (!funcionario || !data) {
            alert("Preencha funcionﾃ｡rio e data!");
            return;
        }
        
        const horarios = [];
        for (let i = 1; i <= blocos; i++) {
            const entrada = document.getElementById(`entrada${i}`)?.value;
            const saida = document.getElementById(`saida${i}`)?.value;
            if (entrada && saida) horarios.push({ entrada, saida });
        }

        if (horarios.length === 0) {
            alert("Adicione pelo menos um par de Entrada/Saﾃｭda.");
            return;
        }

        try {
            await addDoc(collection(db, "horas"), {
                funcionario: funcionario, 
                data,
                horarios
            });
            
            document.getElementById('data').value = ''; 
            document.getElementById('blocos').innerHTML = '';
            blocos = 0;

            carregarTodosOsDados(); 
            alert(`Registro de horas para ${funcionario} em ${data} salvo com sucesso!`);
        } catch (e) {
            console.error("Erro ao adicionar documento: ", e);
            alert("Erro ao salvar. Verifique a console.");
        }
    }

    window.excluir = async function(id) {
        if (!confirm("Tem certeza que deseja excluir este registro?")) return;
        try {
            await deleteDoc(doc(db, "horas", id));
            carregarTodosOsDados(); 
            alert("Registro excluﾃｭdo com sucesso!");
        } catch (e) {
            console.error("Erro ao excluir: ", e);
            alert("Erro ao excluir. Verifique a console.");
        }
    }

    window.editar = async function(id) {
        try {
            const docRef = doc(db, "horas", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();

                document.getElementById('funcionario').value = data.funcionario;
                // Usa a funﾃｧﾃ｣o getSortableDate para tentar carregar o formato YYYY-MM-DD no input date
                document.getElementById('data').value = getSortableDate(data.data);

                document.getElementById('blocos').innerHTML = '';
                blocos = 0;
                const horarios = Array.isArray(data.horarios) ? data.horarios : []; 

                horarios.forEach(h => {
                    window.addBloco();
                    document.getElementById(`entrada${blocos}`).value = h.entrada;
                    document.getElementById(`saida${blocos}`).value = h.saida;
                });

                const salvarBtn = document.querySelector('button[onclick="window.salvarDados()"]');
                salvarBtn.textContent = 'Atualizar Registro';
                salvarBtn.onclick = () => window.atualizarDados(id);

                alert("Dados carregados para ediﾃｧﾃ｣o. Clique em 'Atualizar Registro' para salvar as mudanﾃｧas.");

            } else {
                alert("Registro nﾃ｣o encontrado!");
            }
        } catch (e) {
            console.error("Erro ao editar: ", e);
            alert("Erro ao carregar dados para ediﾃｧﾃ｣o. Verifique a console.");
        }
    }

    // Lﾃｳgica de Atualizaﾃｧﾃ｣o (Corrigida e Confirmada)
    window.atualizarDados = async function(id) {
        const funcionario = document.getElementById('funcionario').value.trim();
        const data = document.getElementById('data').value; 
        
        const horarios = [];
        for (let i = 1; i <= blocos; i++) { 
            const entrada = document.getElementById(`entrada${i}`)?.value;
            const saida = document.getElementById(`saida${i}`)?.value;
            if (entrada && saida) horarios.push({ entrada, saida });
        }

        if (!funcionario || !data || horarios.length === 0) {
            alert("Preencha funcionﾃ｡rio, data e pelo menos um par de horﾃ｡rios!");
            return;
        }
        
        try {
            const docRef = doc(db, "horas", id);
            await updateDoc(docRef, { funcionario: funcionario, data, horarios });

            const salvarBtn = document.querySelector('button[onclick*="atualizarDados"]');
            
            if (salvarBtn) {
                salvarBtn.textContent = 'Salvar Registro';
                salvarBtn.onclick = () => window.salvarDados();
            }

            document.getElementById('funcionario').value = '';
            document.getElementById('data').value = '';
            document.getElementById('blocos').innerHTML = '';
            blocos = 0; 

            window.carregarTodosOsDados(); 
            alert("Registro atualizado com sucesso!");

        } catch (e) {
            console.error("Erro ao atualizar: ", e);
            alert("Erro ao atualizar. Verifique a console (tecla F12).");
        }
    }

    // #######################################################
    // FUNﾃﾃグ PARA GERAR PDF
    // #######################################################
    
    window.gerarPDF = function() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
            alert("Erro: Biblioteca jsPDF nﾃ｣o carregada. Verifique sua conexﾃ｣o ou os links.");
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text("Relatﾃｳrio de Registros de Horas - Detalhado", 10, 10);
        
        let y = 20;
        let totalGeralMinutosPDF = 0;

        const registrosParaPDF = {};
        registrosGlobais.forEach(reg => { 
            if (!registrosParaPDF[reg.funcionario]) {
                registrosParaPDF[reg.funcionario] = { registros: [], totalMinutos: 0 };
            }
            registrosParaPDF[reg.funcionario].registros.push(reg);
            registrosParaPDF[reg.funcionario].totalMinutos += reg.duracaoMinutos;
        });

        for (const funcionario in registrosParaPDF) {
            const grupo = registrosParaPDF[funcionario];
            
            if (y > 270) { 
                doc.addPage();
                y = 10;
            }

            doc.setFontSize(14);
            doc.text(`Funcionﾃ｡rio: ${funcionario}`, 10, y);
            y += 8;
            
            const head = [["Data", "Entrada", "Saﾃｭda", "Total do Dia"]];
            const body = grupo.registros
                // Ordenaﾃｧﾃ｣o correta para o PDF
                .sort((a, b) => {
                    const dataA = getSortableDate(a.data);
                    const dataB = getSortableDate(b.data);
                    return dataA.localeCompare(dataB);
                })
                .map(reg => [
                    formatarDataBR(reg.data), // Data no formato DD/nome-do-mﾃｪs/YYYY
                    Array.isArray(reg.horarios) ? reg.horarios.map(h => h.entrada).join('\n') : '',
                    Array.isArray(reg.horarios) ? reg.horarios.map(h => h.saida).join('\n') : '',
                    reg.duracaoFormatada
                ]);
            
            doc.autoTable({
                startY: y,
                head: head,
                body: body,
                theme: 'striped',
                margin: { left: 10, right: 10 },
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0, 123, 255] }
            });

            y = doc.autoTable.previous.finalY + 2;
            
            doc.setFontSize(11);
            doc.text(`Total Acumulado: ${formatarMinutosParaHora(grupo.totalMinutos)}`, 10, y + 4);
            y += 10;
            
            totalGeralMinutosPDF += grupo.totalMinutos;
        }

        if (y > 270) { 
             doc.addPage();
             y = 10;
        }
        doc.setFontSize(14);
        doc.text(`Total GERAL dos Registros Exibidos: ${formatarMinutosParaHora(totalGeralMinutosPDF)}`, 10, y + 10);

        doc.save("relatorio_horas_agrupado.pdf");
    }

    // Inicializaﾃｧﾃ｣o
    window.carregarTodosOsDados();
</script>
</body>
</html>